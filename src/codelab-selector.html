<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="elements/codelab-card.html">

<dom-module id="codelab-selector">

  <template>

    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
        padding: 10px;
      }
      codelab-card {
        margin: 10px;
        max-width: 380px;
      }
    </style>

    <div>
      <div class="horizontal end-justified layout">
        <paper-dropdown-menu label="Category" value="{{selectedcategory}}">
          <paper-listbox class="dropdown-content" selected="0">
            <template is="dom-repeat" items="[[categories]]">
              <paper-item>[[item]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>
      <div class="horizontal layout wrap">
        <template is="dom-repeat" items="[[codelabs]]" filter="{{codelabfromscope(listofkeywords, selectedcategory)}}"
              sort="sortcodelabs">
          <codelab-card title="[[item.title]]" summary="[[item.summary]]" category="[[item.category]]"
                        difficulty="[[item.difficulty]]" duration="[[item.duration}}" tags="[[item.tags]]"
                        updated="[[item.updated]]" url="[[item.url]]"
                        categoriesmap="[[categoriesmap]]"></codelab-card>
        </template>

        <iron-ajax
          auto
          url="/api/codelabs.json"
          handle-as="json"
          on-response="_codelabsInfoHandler">
      </div>
    </div>

  </template>

  <script>

    Polymer({

      is: 'codelab-selector',

      properties: {
        codelabs: {
          type: Array,
          value: function() {
            return [];
          }
        },
        categoriesmap: Object,
        currentSearch: {
          type: String,
          observer: '_updatekeywords',
        },
        listofkeywords: {
          type: Array,
          value: function() {
            return [];
          },
        },
        categories: {
          type: Array,
          computed: "_buildcategories(categoriesmap)",
        }
      },

      codelabfromscope: function(listofkeywords, selectedcategory) {
        // return a filter function for the current search string
        return function(item) {
          var title = item.title.toLowerCase();
          var summary = item.summary.toLowerCase();
          var category = item.category[0].toLowerCase();
          var tags = item.tags;

          if (selectedcategory !== category && selectedcategory !== "All")
            return false;
          if (listofkeywords.length === 0)
            return true;

          var should_show = true;
          listofkeywords.forEach(function(searchterm) {
            var searchterm_found = false;
            if (title.indexOf(searchterm) !== -1 || summary.indexOf(searchterm) !== -1 ||
                category.indexOf(searchterm) !== -1) {
              searchterm_found = true;
            }
            tags.forEach(function(tag) {
              if (tag.toLowerCase().indexOf(searchterm) !== -1) {
                searchterm_found = true;
              }
            }, this);
            should_show = should_show && searchterm_found;
          }, this);
          return should_show;
        };
      },

      sortcodelabs: function(codelab1, codelab2) {
        return codelab1.difficulty > codelab2.difficulty;
      },

      _codelabsInfoHandler: function(event) {
        this.categoriesmap = event.detail.response["categories"];
        event.detail.response["codelabs"].forEach(function(codelab) {
          this.push("codelabs", codelab);
        }, this);
      },

      _updatekeywords: function() {
        // protect against uninitialized javascript
        if (typeof this.listofkeywords === "undefined") {
          return;
        }
        this.listofkeywords = [];
        this.currentSearch.split(" ").forEach(function(searchterm) {
          this.listofkeywords.push(searchterm.toLowerCase())
        }, this);
      },

      _buildcategories: function(categoriesmap) {
        var newcategories = Object.keys(categoriesmap).sort();
        newcategories.unshift("All");
        newcategories.delete("unknown");
        return newcategories;
      },
    });

  </script>

</dom-module>

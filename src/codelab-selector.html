<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="elements/codelab-card.html">

<dom-module id="codelab-selector">

  <template>

    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
        padding: 10px;
      }
      codelab-card {
        margin: 10px;
        max-width: 350px;
      }
    </style>

    <div class="horizontal layout wrap">
      <template is="dom-repeat" items="[[codelabs]]" filter="{{codelabfromscope(listofkeywords)}}">
        <codelab-card title="[[item.title]]" summary="[[item.summary]]" theme="[[item.theme]]"
                      difficulty="[[item.difficulty]]" duration="[[item.duration}}" tags="[[item.tags]]"
                      updated="[[item.updated]]" url="[[item.url]]"
                      themesmap="[[themesmap]]"></codelab-card>
      </template>

      <iron-ajax
        auto
        url="/api/codelabs.json"
        handle-as="json"
        on-response="_codelabsInfoHandler">
    </div>

  </template>

  <script>

    Polymer({

      is: 'codelab-selector',

        properties: {
          codelabs: {
            type: Array,
            value: function() {
              return [];
            }
          },
          themesmap: Object,
          currentSearch: {
            type: String,
            observer: '_updatekeywords',
          },
          listofkeywords: {
            type: Array,
            value: function() {
              return [];
            },
          },
        },

        codelabfromscope: function(listofkeywords) {
          // return a filter function for the current search string
          return function(item) {
            console.log(listofkeywords);
            if (listofkeywords.length === 0)
              return true;
            var returnvalue = false;
            var title = item.title.toLowerCase();
            var summary = item.summary.toLowerCase();
            var theme = item.theme.toLowerCase();
            var tags = item.tags;
            listofkeywords.forEach(function(searchterm) {
              if (title.indexOf(searchterm) !== -1 || summary.indexOf(searchterm) !== -1 ||
                  theme.indexOf(searchterm) !== -1) {
                returnvalue = true;
              }
              tags.forEach(function(tag) {
                if (tag.toLowerCase().indexOf(searchterm) !== -1) {
                  returnvalue = true;
                }
              }, this);
            }, this);
            return returnvalue;
          };
        },

        _codelabsInfoHandler: function(event) {
          this.themesmap = event.detail.response["themes"];
          event.detail.response["codelabs"].forEach(function(codelab) {
            this.push("codelabs", codelab);
          }, this);
        },

        _updatekeywords: function() {
          // protect against uninitialized javascript
          if (typeof this.listofkeywords === "undefined") {
            return;
          }
          this.listofkeywords = [];
          this.currentSearch.split(" ").forEach(function(searchterm) {
            this.listofkeywords.push(searchterm.toLowerCase())
          }, this);
        }
    });

  </script>

</dom-module>
